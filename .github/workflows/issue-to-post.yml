name: Convert Issue to Blog Post

# 添加權限設定
permissions:
  contents: write # 允許寫入 repo 內容
  issues: read # 允許讀取 issue 內容

on:
  issues:
    types: [closed]

jobs:
  convert-issue:
    runs-on: ubuntu-latest
    # 只處理有特定 label 的 issue，例如 "convert-to-post"
    if: contains(github.event.issue.labels.*.name, 'convert-to-post')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install @octokit/rest gray-matter dotenv
          # 添加 type: module 到 package.json
          npm pkg set type=module

      - name: Convert Issue to MDX
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: node .github/scripts/convert-issue.js

      - name: Commit and Push
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/blog/
          git commit -m "[Cursor] Convert issue #${{ github.event.issue.number }} to blog post"
          git push
